@model List<contract_claim.Models.Claim>

@{
    ViewData["Title"] = "HR Analytics";

    // Retrieve Year and Month safely
    int year = ViewBag.Year ?? DateTime.Now.Year;

    int month = 0; // 0 = All Months
    if (ViewBag.Month != null)
        month = Convert.ToInt32(ViewBag.Month);
}

<h2>HR Analytics</h2>
<p class="text-muted">Overview of claim statuses, payouts and lecturer performance.</p>

<!-- FILTER FORM -->
<form method="get" class="mt-4 mb-4">
    <div class="row">

        <!-- YEAR -->
        <div class="col-md-4">
            <label>Year</label>
            <input type="number" name="year"
                   class="form-control"
                   value="@year"
                   min="2020"
                   max="2100" />
        </div>

        <!-- MONTH -->
        <div class="col-md-4">
            <label>Month</label>
            <select name="month" class="form-select">

                @if (month == 0)
                {
                    <option value="" selected>All Months</option>
                }
                else
                {
                    <option value="">All Months</option>
                }

                @for (int m = 1; m <= 12; m++)
                {
                    if (month == m)
                    {
                        <option value="@m" selected>
                            @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)
                        </option>
                    }
                    else
                    {
                        <option value="@m">
                            @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)
                        </option>
                    }
                }

            </select>
</div>


        <!-- FILTER BUTTON -->
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100">Filter</button>
        </div>
    </div>
</form>


<!-- STAT CARDS -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="p-3 bg-success text-white text-center rounded shadow-sm stat-card">
            <h5>Approved</h5>
            <h3>@ViewBag.Approved</h3>
        </div>
    </div>

    <div class="col-md-4">
        <div class="p-3 bg-warning text-dark text-center rounded shadow-sm stat-card">
            <h5>Pending</h5>
            <h3>@ViewBag.Pending</h3>
        </div>
    </div>

    <div class="col-md-4">
        <div class="p-3 bg-danger text-white text-center rounded shadow-sm stat-card">
            <h5>Rejected</h5>
            <h3>@ViewBag.Rejected</h3>
        </div>
    </div>
</div>


<!-- PIE CHART -->
<div class="mt-4 d-flex justify-content-center">
    <div style="max-width: 400px; width: 100%;">
        <canvas id="statusPie"></canvas>
    </div>
</div>

<!-- BAR CHART -->
<div class="mt-5 d-flex justify-content-center">
    <div style="max-width: 600px; width: 100%;">
        <canvas id="payoutBar"></canvas>
    </div>
</div>

<!-- LINE CHART -->
<div class="mt-5 d-flex justify-content-center">
    <div style="max-width: 800px; width: 100%;">
        <canvas id="payoutLine"></canvas>
    </div>
</div>

<!-- LECTURER COMPARISON -->
<div class="mt-5 d-flex justify-content-center">
    <div style="max-width: 800px; width: 100%;">
        <canvas id="lecturerCompare"></canvas>
    </div>
</div>


<style>
    canvas { max-height: 300px !important; }

    .stat-card {
        transition: 0.25s ease;
        cursor: pointer;
    }

    .stat-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.28);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------------- PIE CHART ---------------- */
new Chart(document.getElementById("statusPie"), {
    type: 'pie',
    data: {
        labels: ['Approved', 'Pending', 'Rejected'],
        datasets: [{
            data: [@ViewBag.Approved, @ViewBag.Pending, @ViewBag.Rejected],
            backgroundColor: ['#198754', '#ffc107', '#dc3545']
        }]
    }
});

/* ---------------- BAR CHART ---------------- */
new Chart(document.getElementById("payoutBar"), {
    type: 'bar',
    data: {
        labels: ['Total Approved Payout'],
        datasets: [{
            label: 'Rands',
            data: [@ViewBag.TotalPayout],
            backgroundColor: ['#0d6efd']
        }]
    }
});

/* ---------------- LINE CHART ---------------- */
const payoutLabels = [
@foreach (var group in Model
    .Where(c => c.Status == "Approved" && c.ApprovedDate.HasValue)
    .GroupBy(c => c.ApprovedDate.Value.ToString("yyyy-MM")))
{
@: "@group.Key",
}
];

const payoutData = [
@foreach (var group in Model
    .Where(c => c.Status == "Approved" && c.ApprovedDate.HasValue)
    .GroupBy(c => c.ApprovedDate.Value.ToString("yyyy-MM")))
{
@: @group.Sum(c => c.TotalAmount),
}
];

new Chart(document.getElementById("payoutLine"), {
    type: 'line',
    data: {
        labels: payoutLabels,
        datasets: [{
            label: "Payout Trend",
            data: payoutData,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13,110,253,0.3)',
            fill: true,
            tension: 0.3
        }]
    }
});

/* ---------------- LECTURER COMPARISON ---------------- */
const lecturerLabels = [
@foreach (var group in Model.Where(c => c.Status == "Approved").GroupBy(c => c.LecturerName))
{
@: "@group.Key",
}
];

const lecturerTotals = [
@foreach (var group in Model.Where(c => c.Status == "Approved")
                            .GroupBy(c => c.LecturerName))
{
@: @group.Sum(x => x.TotalAmount),
}
];

new Chart(document.getElementById("lecturerCompare"), {
    type: 'bar',
    data: {
        labels: lecturerLabels,
        datasets: [{
            label: "Approved Payout Per Lecturer",
            data: lecturerTotals,
            backgroundColor: '#6610f2'
        }]
    }
});
</script>